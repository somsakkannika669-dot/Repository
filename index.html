<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rin SHOP</title>

<!-- PromptPay + QR -->
<script src="https://cdn.jsdelivr.net/npm/promptpay-qr"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body{margin:0;font-family:sans-serif;background:#111;color:#fff;text-align:center}
header{background:#000;padding:20px;font-size:24px;font-weight:bold}
.container{padding:20px}
.card{background:#1e1e1e;padding:15px;margin:10px;border-radius:10px}
button{background:#00ff88;border:none;padding:8px 16px;margin:5px;border-radius:6px;font-weight:bold}
input{padding:8px;margin:5px;border-radius:6px;border:none}
.admin{background:#222;padding:15px;margin-top:30px;border-radius:10px}
#paymentModal{display:none;position:fixed;inset:0;background:#000000dd;justify-content:center;align-items:center}
.modalBox{background:#111;padding:20px;border-radius:12px}
img{max-width:150px;border-radius:8px}
</style>
</head>
<body>

<header>Rin SHOP</header>

<div class="container">
<h2>สินค้า</h2>
<div id="product-list"></div>
</div>

<div class="admin" id="admin-section" style="display:none;">
<h2>เพิ่มสินค้า (แอดมิน)</h2>
<input type="text" id="name" placeholder="ชื่อสินค้า">
<input type="number" id="price" placeholder="ราคา">
<input type="number" id="stock" placeholder="จำนวนสต็อก">
<button onclick="addProduct()">เพิ่มสินค้า</button>

<h2>ออเดอร์รอตรวจสอบ</h2>
<div id="ordersList"></div>
</div>

<div>
<h3>ล็อกอินแอดมิน</h3>
<input type="email" id="email" placeholder="Email">
<input type="password" id="password" placeholder="Password">
<button onclick="login()">เข้าสู่ระบบ</button>
<button onclick="logout()">ออกจากระบบ</button>
</div>

<!-- PAYMENT MODAL -->
<div id="paymentModal">
  <div class="modalBox">
    <h3>สแกนจ่าย</h3>
    <canvas id="qrcode"></canvas><br><br>
    <input type="file" id="slipUpload"><br><br>
    <button onclick="confirmPayment()">ยืนยันการชำระเงิน</button>
    <button onclick="closeModal()">ปิด</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, getDoc } 
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL }
from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "bgod-shop.firebaseapp.com",
  projectId: "bgod-shop",
  storageBucket: "bgod-shop.appspot.com",
  messagingSenderId: "YOUR_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

let currentOrder = null;

// โหลดสินค้า
async function loadProducts(){
  const snapshot = await getDocs(collection(db,"products"));
  const list = document.getElementById("product-list");
  list.innerHTML="";
  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    list.innerHTML += `
      <div class="card">
        <h3>${data.name}</h3>
        <p>${data.price} บาท</p>
        <p>คงเหลือ ${data.stock}</p>
        <button onclick="orderProduct('${docSnap.id}','${data.name}',${data.price},${data.stock})">
          สั่งซื้อ
        </button>
      </div>
    `;
  });
}
window.orderProduct = function(id,name,price,stock){
  if(stock<=0){alert("สินค้าหมด");return;}
  const customerName = prompt("กรอกชื่อผู้สั่งซื้อ:");
  const payload = PromptPayQR.generate("0989871584",{amount:price});
  QRCode.toCanvas(document.getElementById("qrcode"),payload);
  currentOrder = {id,name,price,customerName};
  document.getElementById("paymentModal").style.display="flex";
}
window.closeModal = function(){
  document.getElementById("paymentModal").style.display="none";
}
window.confirmPayment = async function(){
  const file = document.getElementById("slipUpload").files[0];
  if(!file)return alert("แนบสลิปก่อน");
  const storageRef = ref(storage,"slips/"+Date.now());
  await uploadBytes(storageRef,file);
  const slipURL = await getDownloadURL(storageRef);
  await addDoc(collection(db,"orders"),{
    productId:currentOrder.id,
    productName:currentOrder.name,
    price:currentOrder.price,
    customerName:currentOrder.customerName,
    slipURL:slipURL,
    status:"pending",
    createdAt:new Date()
  });
  alert("บันทึกออเดอร์แล้ว");
  closeModal();
}

// เพิ่มสินค้า
window.addProduct = async function(){
  const name=document.getElementById("name").value;
  const price=Number(document.getElementById("price").value);
  const stock=Number(document.getElementById("stock").value);
  await addDoc(collection(db,"products"),{name,price,stock});
  alert("เพิ่มสินค้าแล้ว");
  loadProducts();
}

// โหลดออเดอร์
async function loadOrders(){
  const snapshot=await getDocs(collection(db,"orders"));
  const container=document.getElementById("ordersList");
  container.innerHTML="";
  snapshot.forEach(docSnap=>{
    const data=docSnap.data();
    if(data.status==="pending"){
      container.innerHTML+=`
        <div class="card">
          <p>${data.productName} - ${data.customerName}</p>
          <img src="${data.slipURL}">
          <button onclick="approveOrder('${docSnap.id}','${data.productId}')">
            อนุมัติ
          </button>
        </div>
      `;
    }
  });
}
window.approveOrder = async function(orderId,productId){
  const productRef=doc(db,"products",productId);
  const snap=await getDoc(productRef);
  const productData=snap.data();
  await updateDoc(productRef,{stock:productData.stock-1});
  await updateDoc(doc(db,"orders",orderId),{status:"approved"});
  alert("อนุมัติแล้ว");
  loadOrders();
  loadProducts();
}

// AUTH
window.login = function(){
  const email=document.getElementById("email").value;
  const password=document.getElementById("password").value;
  signInWithEmailAndPassword(auth,email,password)
    .then(()=>alert("ล็อกอินสำเร็จ"))
    .catch(e=>alert(e.message));
}
window.logout = function(){signOut(auth);}
onAuthStateChanged(auth,user=>{
  if(user){
    document.getElementById("admin-section").style.display="block";
    loadOrders();
  }else{
    document.getElementById("admin-section").style.display="none";
  }
});

loadProducts();
</script>

</body>
</html>
